name: Zero Downtime Blue-Green Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️⃣ Login to Docker Hub
      - name: Docker Login
        run: |
          echo "${{ secrets.DOCKER_TOKEN }}" | docker login \
            -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      # 3️⃣ Build & push FRONTEND image (blue + green)
      - name: Build and Push Frontend Image (blue & green)
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/hostel-outpass-frontend:latest \
            -f Dockerfile.frontend .

          docker tag ${{ secrets.DOCKER_USERNAME }}/hostel-outpass-frontend:latest \
            ${{ secrets.DOCKER_USERNAME }}/hostel-outpass-frontend:blue

          docker tag ${{ secrets.DOCKER_USERNAME }}/hostel-outpass-frontend:latest \
            ${{ secrets.DOCKER_USERNAME }}/hostel-outpass-frontend:green

          docker push ${{ secrets.DOCKER_USERNAME }}/hostel-outpass-frontend:blue
          docker push ${{ secrets.DOCKER_USERNAME }}/hostel-outpass-frontend:green



      - name: Build and Push Backend Image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/hostel-outpass-backend:latest \
            -f Dockerfile.backend .
          docker push ${{ secrets.DOCKER_USERNAME }}/hostel-outpass-backend:latest


      # 5️⃣ Setup SSH
      - name: Setup SSH
        shell: bash
        run: |
          set -e
          mkdir -p "$HOME/.ssh"
          printf "%s\n" "${{ secrets.SSH_PRIVATE_KEY }}" > "$HOME/.ssh/hostel-outpass-key.pem"
          chmod 600 "$HOME/.ssh/hostel-outpass-key.pem"
          ssh-keyscan -H "${{ secrets.CONTROL_EC2_IP }}" >> "$HOME/.ssh/known_hosts"

      # 6️⃣ Ensure Ansible directory exists on Control Node
      - name: Prepare Ansible directory on Control Node
        run: |
          ssh -i ~/.ssh/hostel-outpass-key.pem \
            ${{ secrets.EC2_USER }}@${{ secrets.CONTROL_EC2_IP }} \
            "mkdir -p /home/ubuntu/ansible"
            
      # 7️⃣ Sync Ansible code to Control Node
      - name: Sync Ansible code
        run: |
          rsync -avz \
            -e "ssh -i ~/.ssh/hostel-outpass-key.pem" \
            ansible/ \
            ${{ secrets.EC2_USER }}@${{ secrets.CONTROL_EC2_IP }}:/home/ubuntu/ansible/



      # 7️⃣ Detect CURRENT live color (single source of truth = NGINX)
      - name: Detect current live color
        id: detect
        run: |
          ssh -i ~/.ssh/hostel-outpass-key.pem \
            ${{ secrets.EC2_USER }}@${{ secrets.CONTROL_EC2_IP }} << 'EOF'
            cd ~/ansible/hostel

            CURRENT_COLOR=$(ansible-playbook -i inventory.ini deploy.yml \
              --check | grep "current_live_color" | awk '{print $2}')

            if [ "$CURRENT_COLOR" = "blue" ]; then
              echo "inactive_color=green" > /tmp/color.txt
            else
              echo "inactive_color=blue" > /tmp/color.txt
            fi
          EOF

          echo "inactive_color=$(ssh -i ~/.ssh/hostel-outpass-key.pem \
            ${{ secrets.EC2_USER }}@${{ secrets.CONTROL_EC2_IP }} cat /tmp/color.txt | cut -d= -f2)" \
            >> $GITHUB_OUTPUT

      # 8️⃣ Deploy inactive frontend + backend, then switch traffic
      - name: Deploy and Switch Traffic
        run: |
          ssh -i ~/.ssh/hostel-outpass-key.pem \
            ${{ secrets.EC2_USER }}@${{ secrets.CONTROL_EC2_IP }} << 'EOF'
            cd ~/ansible/hostel
            ansible-playbook -i inventory.ini deploy.yml \
              -e live_color=${{ steps.detect.outputs.inactive_color }}
          EOF
